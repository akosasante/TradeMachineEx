
services:
  # TradeMachineEx Application (Production)
  app:
    image: ${IMAGE_TAG:-ghcr.io/akosasante/trade-machine-ex:latest}
    ports:
      - "4001:4000"  # Phoenix application
    environment:
      - MIX_ENV=prod
      - PORT=4000

      # Database configuration (external PostgreSQL)
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - DATABASE_NAME=${DATABASE_NAME:-trade_machine}
      - DATABASE_PORT=${DATABASE_PORT:-5432}
      - DATABASE_POOL_SIZE=${DATABASE_POOL_SIZE:-10}
      - DATABASE_SCHEMA=${DATABASE_SCHEMA:-staging}

      # Phoenix configuration
      - SECRET_KEY_BASE=${SECRET_KEY_BASE}
      - PHX_HOST=${PHX_HOST}

      # Logging configuration
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # Google Sheets integration (optional)
      - GOOGLE_SHEETS_CREDS_PATH=${GOOGLE_SHEETS_CREDS_PATH:-}
      - GOOGLE_SPREADSHEET_ID=${GOOGLE_SPREADSHEET_ID:-}

      # Job processing configuration
      - ENABLE_CRON=${ENABLE_CRON:-false}
      - OBAN_MINORS_SYNC_CONCURRENCY=${OBAN_MINORS_SYNC_CONCURRENCY:-1}
      - OBAN_DRAFT_SYNC_CONCURRENCY=${OBAN_DRAFT_SYNC_CONCURRENCY:-1}

      # Monitoring configuration
      - GRAFANA_HOST=${GRAFANA_HOST:-}
      - GRAFANA_TOKEN=${GRAFANA_TOKEN:-}

    networks:
      - trade_machine_network

    # Resource limits for production
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    labels:
      - "service=trade_machine_ex"
      - "environment=production"
      - "com.centurylinklabs.watchtower.enable=true"

networks:
  trade_machine_network:
    driver: bridge
    labels:
      - "service=trade_machine_ex"